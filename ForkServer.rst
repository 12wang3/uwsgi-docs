The Fork Server (sponsored by Intellisurvey)
============================================

This is a really advanced (and complex) feature developed thanks to intellisurvey.com

If you have dozens (hundreds ?) of applications built upon the same codebase you can setup your Emperor to fork vassals
from an already running one (with the application core loaded).

Currently the feature is supported only in the PSGI plugin, and requires a Linux kernel >= 3.4

How it works
------------

When in fork-server mode, the Emperor differentiate between two kind of vassals: base and adopted.

"base" vassals are pretty classic vassals, as they are generated by a fork() + execve() by the Emperor. The only difference is that they are supposed
to load your application code as soon as possible and then suspend themself waiting for connections on a UNIX socket.

A "base" vassal will be something like that

.. code-block:: ini

   [uwsgi]
   ; load myapp.pl as soon as possible
   early-psgi = myapp.pl
   ; suspend and execution and bind on UNIX socket /tmp/fork_server.socket
   fork-server = /tmp/fork_server.socket
   
"adopted" vassals are the true "new thing".

Once an adopted vassal is requested, the Emperor connects to the specified fork server (instead of calling fork() + execve()).

The Emperor passes a uwsgi-serialized-array of the commandline options of the new vassal and upto 3 file descriptors (remember UNIX sockets allow passing file descriptors from one process to another).

Those 3 file descriptors are:

1 -> the communication pipe with the Emperor (required)

2 -> the config pipe (optional)

3 -> on_demand socket (optional)

At this point, the fork server fork() itself two times and continue the uWSGI startup using the supplied arguments array.

How the Emperor can wait() on an external process ? This is why a >= 3.4 kernel is required, as thanks to the prctl(PR_SET_CHILD_SUBREAPER, 1) we can tell
vassals to be re-parented to the Emperor when their parent dies (infact the fork-server forks two times, so the vassal has no parent).

Now the Emperor has a new child and a communication pipe. And that's all.

Configuring the Emperor for fork-server mode
---------------------------------------------

You need only two new options: ``--emperor-use-fork-serve <addr>`` and ``--vassal-fork-base <name>``
